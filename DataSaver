--[[
DataSaver - Centralized Data Persistence System

This module is the ONLY one authorized to:

- Create ProfileStore

- Call StartSessionAsync

- Handle OnSessionEnd

- Save and load data

OBJECTIVE:

- A single profile per player (DefinitiveInventory)

- Universal recursive deep serialization
--]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Modules = ReplicatedStorage:WaitForChild("Modules")
local DataModules = Modules:WaitForChild("Data")

local Trove = require(DataModules:WaitForChild("Trove"))
local ProfileStore = require(DataModules:WaitForChild("ProfileStore"))


local PROFILE_STORE_NAME = "Inventory"
local DATA_VERSION = 1 

local PROFILE_TEMPLATE = {
	_Version = DATA_VERSION,

	PlayerData = {
		Money = 1500,
		Rebirth = 0,
		Slots = 1,
		Multiplier = 1
	},

	Index = {},

	Inventory = {
		Ingredients = {}, 
		Juices = {},      
		Gears = {}       
	},

	PlacedJuices = {},

	Shakers = {
		ShakerContents = {},
		ActiveShakes = {},
		SaveTime = 0
	},

	Config = {
		Music = true,
		SoundEffects = true,
		VisualEffects = true,
		ChatTips = true,
		PlotMap = "Normal",
	},

	Gamepasses = {},

	Tutorial = {
		HasSeenTutorial = false
	},

	VIPRewards = {
		GamePassRewardClaimed = false
	},

	GroupRewards = {
		GroupRewardClaimed = false
	},

	CurrentMarketStock = {},
	LastMarketSeed = 0,

	DiscordVerified = false,
	CommunityVerified = false,
}


local DataSaverStore = ProfileStore.New(PROFILE_STORE_NAME, PROFILE_TEMPLATE)
local Profiles = {} 
local PlayerTroves = {} 


local function SerializeInstance(instance)
	if not instance then
		return nil
	end

	if instance:IsA("IntValue") and instance.Name == "Id" then
		return nil
	end

	local data = {
		ClassName = instance.ClassName,
		Name = instance.Name
	}

	if instance:IsA("StringValue") then
		data.Value = instance.Value
	elseif instance:IsA("IntValue") then
		data.Value = instance.Value
	elseif instance:IsA("NumberValue") then
		data.Value = instance.Value
	elseif instance:IsA("BoolValue") then
		data.Value = instance.Value
	end

	local children = {}
	for _, child in ipairs(instance:GetChildren()) do
		if child:IsA("IntValue") and child.Name == "Id" then
			continue
		end

		if child:IsA("Folder") or child:IsA("StringValue") or child:IsA("IntValue")
			or child:IsA("NumberValue") or child:IsA("BoolValue") then
			local serialized = SerializeInstance(child)
			if serialized then
				table.insert(children, serialized)
			end
		end
	end

	if #children > 0 then
		data.Children = children
	end

	return data
end

local function DeserializeInstance(data, parent)
	if not data or not parent then
		return nil
	end

	local instance = Instance.new(data.ClassName)
	instance.Name = data.Name
	instance.Parent = parent

	if data.Value ~= nil then
		instance.Value = data.Value
	end

	if data.Children then
		for _, childData in ipairs(data.Children) do
			DeserializeInstance(childData, instance)
		end
	end

	return instance
end

local function SerializeFolder(folder)
	if not folder then
		return {}
	end

	local data = {}
	for _, child in ipairs(folder:GetChildren()) do
		if child:IsA("Folder") or child:IsA("StringValue") or child:IsA("IntValue")
			or child:IsA("NumberValue") or child:IsA("BoolValue") then
			table.insert(data, SerializeInstance(child))
		end
	end

	return data
end

local function DeserializeFolder(data, folder)
	if not folder then
		return
	end

	for _, child in ipairs(folder:GetChildren()) do
		child:Destroy()
	end

	if data then
		for _, childData in ipairs(data) do
			DeserializeInstance(childData, folder)
		end
	end
end


local DataSaver = {}

function DataSaver.GetData(player: Player)
	local profile = DataSaver.GetProfile(player)

	local count = 0
	while profile == nil and count < 30 do
		count += task.wait()

		profile = DataSaver.GetProfile(player)
	end

	return if profile then profile.Data else nil
end

function DataSaver.GetProfile(player)
	return Profiles[player]
end

function DataSaver.SaveProfile(player)
	local profile = Profiles[player]
	if profile then
		profile:Save()
	end
end

function DataSaver.SerializeAndSave(player, folderPath, profileSection)
	local profile = Profiles[player]
	if not profile then
		warn(`[DataSaver]: No profile found for {player.Name}`)
		return
	end

	local folder = player:FindFirstChild(folderPath)
	if not folder then
		warn(`[DataSaver]: Folder {folderPath} not found for {player.Name}`)
		return
	end

	local section = profile.Data
	for key in string.gmatch(profileSection, "[^.]+") do
		if not section[key] then
			section[key] = {}
		end
		section = section[key]
	end

	local parent = profile.Data
	local keys = {}
	for key in string.gmatch(profileSection, "[^.]+") do
		table.insert(keys, key)
	end

	for i = 1, #keys - 1 do
		parent = parent[keys[i]]
	end

	parent[keys[#keys]] = SerializeFolder(folder)
end

function DataSaver.LoadAndDeserialize(player, profileSection, folderPath)
	local profile = Profiles[player]
	if not profile then
		warn(`[DataSaver]: No profile found for {player.Name}`)
		return
	end

	local section = profile.Data
	for key in string.gmatch(profileSection, "[^.]+") do
		if not section[key] then
			return
		end
		section = section[key]
	end

	local folder = player:FindFirstChild(folderPath)
	if not folder then
		folder = Instance.new("Folder")
		folder.Name = folderPath
		folder.Parent = player
	end

	DeserializeFolder(section, folder)
end

local function LoadPlayerProfile(player)
	local profile = DataSaverStore:StartSessionAsync(tostring(player.UserId), {
		Cancel = function()
			return player.Parent ~= Players
		end,
	})

	if not profile then
		player:Kick("Failed to load profile - Please rejoin")
		return nil
	end

	profile:AddUserId(player.UserId)
	profile:Reconcile()

	profile.OnSessionEnd:Connect(function()
		Profiles[player] = nil
		if player.Parent == Players then
			player:Kick("Profile session ended - Please rejoin")
		end
	end)

	if player.Parent ~= Players then
		profile:EndSession()
		return nil
	end

	Profiles[player] = profile

	local playerTrove = Trove.new()
	PlayerTroves[player] = playerTrove

	print(`[DataSaver]: Profile loaded for {player.Name} (UserId: {player.UserId})`)

	return profile
end

local function UnloadPlayerProfile(player)
	if PlayerTroves[player] then
		PlayerTroves[player]:Destroy()
		PlayerTroves[player] = nil
	end

	local profile = Profiles[player]
	if profile then
		profile:EndSession()
		Profiles[player] = nil
	end

	print(`[DataSaver]: Profile unloaded for {player.Name}`)
end

local mainTrove = Trove.new()

mainTrove:Connect(Players.PlayerAdded, function(player)
	task.spawn(LoadPlayerProfile, player)
end)

mainTrove:Connect(Players.PlayerRemoving, function(player)
	UnloadPlayerProfile(player)
end)

for _, player in ipairs(Players:GetPlayers()) do
	task.spawn(LoadPlayerProfile, player)
end


DataSaver.SerializeInstance = SerializeInstance
DataSaver.DeserializeInstance = DeserializeInstance
DataSaver.SerializeFolder = SerializeFolder
DataSaver.DeserializeFolder = DeserializeFolder

return DataSaver
